<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>roger.roger &mdash; RoGeR 0.0.1+41.gdf5e102.dirty documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> RoGeR
          </a>
              <div class="version">
                0.0.1+41.gdf5e102.dirty
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Start here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introduction.html">A short introduction to Roger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/get-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/advanced-installation.html">Advanced installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/analysis.html">Analysis of Roger output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/cluster.html">Running Roger on a cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/dev.html">Making changes in Roger</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model equations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../equations/equations.html">Model equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../equations/hydrologic_cycle.html">Hydrologic cycle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../equations/solute_transport.html">Solute transport</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/model-gallery.html">Model gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/settings.html">Constant model parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/variables.html">Model variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/diagnostics.html">Diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/cli.html">Command line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/public-api.html">Python API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../more/benchmarks.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more/howtocite.html">How to cite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more/publications.html">Publications involving Roger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Hydrology-IFH/roger">Visit us on GitHub</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">RoGeR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>roger.roger</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for roger.roger</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>

<span class="c1"># do not import roger.core here!</span>
<span class="kn">from</span> <span class="nn">roger</span> <span class="kn">import</span> <span class="n">settings</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">distributed</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">runtime_settings</span> <span class="k">as</span> <span class="n">rs</span><span class="p">,</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">roger.state</span> <span class="kn">import</span> <span class="n">get_default_state</span>
<span class="kn">from</span> <span class="nn">roger.plugins</span> <span class="kn">import</span> <span class="n">load_plugin</span>
<span class="kn">from</span> <span class="nn">roger.routines</span> <span class="kn">import</span> <span class="n">roger_routine</span><span class="p">,</span> <span class="n">is_roger_routine</span>
<span class="kn">from</span> <span class="nn">roger.timer</span> <span class="kn">import</span> <span class="n">timer_context</span>


<div class="viewcode-block" id="RogerSetup"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup">[docs]</a><span class="k">class</span> <span class="nc">RogerSetup</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main class for roger, used for building a model and running it.</span>

<span class="sd">    Note:</span>
<span class="sd">        This class is meant to be subclassed. Subclasses need to implement the</span>
<span class="sd">        methods :meth:`set_parameters`, :meth:`set_topography`, :meth:`set_grid`,</span>
<span class="sd">        :meth:`set_coriolis`, :meth:`set_initial_conditions`, :meth:`set_forcing`,</span>
<span class="sd">        and :meth:`set_diagnostics`.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; from roger import RogerSetup</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; class MyModel(RogerSetup):</span>
<span class="sd">        &gt;&gt;&gt;     ...</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; model = MyModel()</span>
<span class="sd">        &gt;&gt;&gt; model.run()</span>
<span class="sd">        &gt;&gt;&gt; plt.imshow(model.state.variables.theta[..., 1])</span>
<span class="sd">        &gt;&gt;&gt; plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__roger_plugins__</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">override_settings</span> <span class="o">=</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># this should be the first time the core routines are imported</span>
        <span class="kn">import</span> <span class="nn">roger.core</span>  <span class="c1"># noqa: F401</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_interfaces</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">load_plugin</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__roger_plugins__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_done</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">get_default_state</span><span class="p">(</span><span class="n">use_plugins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__roger_plugins__</span><span class="p">)</span>

<div class="viewcode-block" id="RogerSetup.set_settings"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_settings">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        First function to be called during setup.</span>
<span class="sd">        Use this functions to set the model settings and define physical</span>
<span class="sd">        constants.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; def set_settings(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     settings = state.settings</span>
<span class="sd">          &gt;&gt;&gt;     settings.nx, settings.ny, settings.nz = (360, 120, 2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_look_up_tables"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_look_up_tables">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_look_up_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Use this function to set the look-up tables.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; def set_look_up_tables(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.lut_ilu = update(vs.lut_ilu, at[:, :], lut.ARR_ILU)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_parameters_setup"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_parameters_setup">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_parameters_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Use this function to set initial or constant model parameters.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; def set_parameters_setup(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.dmpv = update(vs.dmpv, at[:, :, :, vs.tau], npx.random.rand(vs.dmpv.shape[:-1]))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_parameters"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_parameters">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Use this function to modify the model parameters.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; def set_parameters(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.dmpv = update(vs.dmpv, at[:, :, :, vs.tau], npx.random.rand(vs.dmpv.shape[:-1]))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_initial_conditions_setup"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_initial_conditions_setup">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_initial_conditions_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Use this function to set the initial conditions.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; @roger_method</span>
<span class="sd">          &gt;&gt;&gt; def set_initial_conditions_setup(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.theta_rz = update(vs.theta_rz, at[:, :, :, vs.tau], 0.4)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_initial_conditions"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_initial_conditions">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        May be used to set initial conditions.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; @roger_method</span>
<span class="sd">          &gt;&gt;&gt; def set_initial_conditions(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.theta_rz = update(vs.theta_rz, at[:, :, :, vs.tau], 0.4)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_boundary_conditions_setup"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_boundary_conditions_setup">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_boundary_conditions_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Use this function to set the boundary conditions.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; @roger_method</span>
<span class="sd">          &gt;&gt;&gt; def set_boundary_conditions_setup(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.z_gw = update(vs.z_gw, at[:, :, :, :vs.taup1], 5)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_boundary_conditions"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_boundary_conditions">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_boundary_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        May be used to set boundary conditions.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; @roger_method</span>
<span class="sd">          &gt;&gt;&gt; def set_boundary_conditions(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.z_gw = update(vs.z_gw, at[:, :, :, :vs.taup1], 5)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_grid"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_grid">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Has to set the grid spacings :attr:`x` and :attr:`y`,</span>
<span class="sd">        along with the coordinates of the grid origin, :attr:`x_origin` and</span>
<span class="sd">        :attr:`y_origin`.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; @roger_method</span>
<span class="sd">          &gt;&gt;&gt; def set_grid(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.x_origin, vs.y_origin = 0, 0</span>
<span class="sd">          &gt;&gt;&gt;     vs.x = 1.</span>
<span class="sd">          &gt;&gt;&gt;     vs.y = 1.</span>
<span class="sd">          &gt;&gt;&gt;     vs.z = 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_topography"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_topography">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_topography</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Must specify the model topography by setting :attr:`slope`.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; @roger_method</span>
<span class="sd">          &gt;&gt;&gt; def set_topography(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.slope = update(vs.slope, at[...], 10)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_forcing_setup"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_forcing_setup">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_forcing_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Called within setup, e.g. through</span>
<span class="sd">        :attr:`PREC`, :attr:`TA`, :attr:`PET`.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; @roger_method</span>
<span class="sd">          &gt;&gt;&gt; def set_forcing_setup(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.TA = vs._ta_data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_forcing"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_forcing">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Called before every time step to update the external forcing, e.g. through</span>
<span class="sd">        :attr:`prec`, :attr:`ta`, :attr:`pet`.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; @roger_method</span>
<span class="sd">          &gt;&gt;&gt; def set_forcing(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     vs = state.variables</span>
<span class="sd">          &gt;&gt;&gt;     vs.ta = vs.TA[:, :, vs.itt]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.set_diagnostics"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.set_diagnostics">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be implemented by subclass.</span>

<span class="sd">        Called before setting up the :ref:`diagnostics &lt;diagnostics&gt;`. Use this method e.g. to</span>
<span class="sd">        mark additional :ref:`variables &lt;variables&gt;` for output.</span>

<span class="sd">        Example:</span>
<span class="sd">          &gt;&gt;&gt; @roger_method</span>
<span class="sd">          &gt;&gt;&gt; def set_diagnostics(self, state):</span>
<span class="sd">          &gt;&gt;&gt;     state.diagnostics[&#39;snapshot&#39;].output_variables += [&#39;drho&#39;, &#39;dsalt&#39;, &#39;dtemp&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RogerSetup.after_timestep"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.after_timestep">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">after_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called at the end of each time step. Can be used to define custom, setup-specific</span>
<span class="sd">        events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_ensure_setup_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;setup() method has to be called before running the model&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_warmup_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">warmup_done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;warmup() method has to be called before running the model&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">roger</span> <span class="kn">import</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">restart</span>
        <span class="kn">from</span> <span class="nn">roger.core</span> <span class="kn">import</span> <span class="n">surface</span><span class="p">,</span> <span class="n">soil</span>

        <span class="n">setup_funcs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters_setup</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_grid</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_topography</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_initial_conditions_setup</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_initial_conditions</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_boundary_conditions_setup</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_boundary_conditions</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_diagnostics</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing_setup</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after_timestep</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">setup_funcs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_roger_routine</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> method is not a roger routine. Please make sure to decorate it &quot;</span>
                    <span class="s2">&quot;with @roger_routine and try again.&quot;</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running model setup&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;setup&quot;</span><span class="p">]:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">unlock</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">override_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="n">settings</span><span class="o">.</span><span class="n">check_setting_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">distributed</span><span class="o">.</span><span class="n">validate_decomposition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">initialize_variables</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">create_default_diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">plugin_interfaces</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">diagnostic</span> <span class="ow">in</span> <span class="n">plugin</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">[</span><span class="n">diagnostic</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">diagnostic</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_topography</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_look_up_tables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">restart_input_filename</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="n">surface</span><span class="o">.</span><span class="n">calculate_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="n">soil</span><span class="o">.</span><span class="n">calculate_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">set_initial_conditions_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="n">surface</span><span class="o">.</span><span class="n">calculate_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="n">soil</span><span class="o">.</span><span class="n">calculate_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">diagnostics</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_boundary_conditions_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_boundary_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">restart_input_filename</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">restart</span><span class="o">.</span><span class="n">read_restart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">enable_offline_transport</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">unlock</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">warmup_done</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">warmup_done</span><span class="p">:</span>
            <span class="c1"># write initial values to output</span>
            <span class="n">diagnostics</span><span class="o">.</span><span class="n">diagnose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">diagnostics</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Setup done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">enable_chloride</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">enable_bromide</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">enable_oxygen18</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">enable_deuterium</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">enable_nitrate</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;IMPORTANT: Always check your logger output for warnings</span><span class="se">\n</span><span class="s2"> on diverging solutions. The occurence of warnings may</span><span class="se">\n</span><span class="s2"> require an post-evaluation of the accuracy of</span><span class="se">\n</span><span class="s2"> the numerical solution (e.g. calculate</span><span class="se">\n</span><span class="s2"> standard deviation of dS_num_error or dC_num_error).</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;IMPORTANT: Always check your logger output for warnings</span><span class="se">\n</span><span class="s2"> on diverging solutions. The occurence of warnings may</span><span class="se">\n</span><span class="s2"> require an post-evaluation of the accuracy of</span><span class="se">\n</span><span class="s2"> the numerical solution (e.g. calculate</span><span class="se">\n</span><span class="s2"> standard deviation of dS_num_error and dC_num_error).</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@roger_routine</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">roger</span> <span class="kn">import</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">restart</span>
        <span class="kn">from</span> <span class="nn">roger.core</span> <span class="kn">import</span> <span class="n">surface</span><span class="p">,</span> <span class="n">soil</span><span class="p">,</span> <span class="n">root_zone</span><span class="p">,</span> <span class="n">subsoil</span><span class="p">,</span> <span class="n">groundwater</span><span class="p">,</span> <span class="n">interception</span><span class="p">,</span> <span class="n">snow</span><span class="p">,</span> <span class="n">evapotranspiration</span><span class="p">,</span> <span class="n">infiltration</span><span class="p">,</span> <span class="n">film_flow</span><span class="p">,</span> <span class="n">subsurface_runoff</span><span class="p">,</span> <span class="n">capillary_rise</span><span class="p">,</span> <span class="n">crop</span><span class="p">,</span> <span class="n">groundwater_flow</span><span class="p">,</span> <span class="n">numerics</span><span class="p">,</span> <span class="n">transport</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_setup_done</span><span class="p">()</span>

        <span class="n">vs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">variables</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">settings</span>

        <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">]:</span>
            <span class="n">restart</span><span class="o">.</span><span class="n">write_restart</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">enable_offline_transport</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;boundary conditions&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_boundary_conditions</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;time-variant parameters&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">enable_crop_phenology</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;crops&quot;</span><span class="p">]:</span>
                        <span class="n">crop</span><span class="o">.</span><span class="n">calculate_crop_phenology</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;interception&quot;</span><span class="p">]:</span>
                    <span class="n">interception</span><span class="o">.</span><span class="n">calculate_interception</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;evapotranspiration&quot;</span><span class="p">]:</span>
                    <span class="n">evapotranspiration</span><span class="o">.</span><span class="n">calculate_evapotranspiration</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;snow&quot;</span><span class="p">]:</span>
                    <span class="n">snow</span><span class="o">.</span><span class="n">calculate_snow</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;infiltration&quot;</span><span class="p">]:</span>
                    <span class="n">infiltration</span><span class="o">.</span><span class="n">calculate_infiltration</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">enable_film_flow</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;film flow&quot;</span><span class="p">]:</span>
                        <span class="n">film_flow</span><span class="o">.</span><span class="n">calculate_film_flow</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;subsurface runoff&quot;</span><span class="p">]:</span>
                    <span class="n">subsurface_runoff</span><span class="o">.</span><span class="n">calculate_subsurface_runoff</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;capillary rise&quot;</span><span class="p">]:</span>
                    <span class="n">capillary_rise</span><span class="o">.</span><span class="n">calculate_capillary_rise</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]:</span>
                    <span class="n">surface</span><span class="o">.</span><span class="n">calculate_surface</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]:</span>
                    <span class="n">root_zone</span><span class="o">.</span><span class="n">calculate_root_zone</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]:</span>
                    <span class="n">subsoil</span><span class="o">.</span><span class="n">calculate_subsoil</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]:</span>
                    <span class="n">soil</span><span class="o">.</span><span class="n">calculate_soil</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">enable_groundwater</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;groundwater flow&quot;</span><span class="p">]:</span>
                        <span class="n">groundwater_flow</span><span class="o">.</span><span class="n">calculate_groundwater_flow</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]:</span>
                        <span class="n">groundwater</span><span class="o">.</span><span class="n">calculate_groundwater</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">enable_routing</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;routing&quot;</span><span class="p">]:</span>
                        <span class="k">pass</span>

                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]:</span>
                    <span class="n">numerics</span><span class="o">.</span><span class="n">calc_storage</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

                <span class="n">vs</span><span class="o">.</span><span class="n">itt</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">itt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">vs</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">vs</span><span class="o">.</span><span class="n">dt_secs</span>
                <span class="c1"># write output at end of time step</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">numerics</span><span class="o">.</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solution diverged at iteration </span><span class="si">{</span><span class="n">vs</span><span class="o">.</span><span class="n">itt</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2"> Please evaluate bias of deterministic/numerical solution.</span><span class="se">\n</span><span class="s2"> The bias is written to the model output.&quot;</span><span class="p">)</span>
                    <span class="n">numerics</span><span class="o">.</span><span class="n">calculate_num_error</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">warmup_done</span><span class="p">:</span>
                        <span class="n">diagnostics</span><span class="o">.</span><span class="n">diagnose</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                        <span class="n">diagnostics</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">enable_offline_transport</span><span class="p">:</span>
                <span class="c1"># skip first iteration which contains initial values</span>
                <span class="n">vs</span><span class="o">.</span><span class="n">itt</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">itt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">sas_solver</span> <span class="o">==</span> <span class="s1">&#39;deterministic&#39;</span><span class="p">:</span>
                    <span class="n">vs</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">vs</span><span class="o">.</span><span class="n">dt_secs</span>

                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;main transport&quot;</span><span class="p">]:</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;boundary conditions&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_boundary_conditions</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;time-variant parameters&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;StorAge selection&quot;</span><span class="p">]:</span>
                        <span class="n">transport</span><span class="o">.</span><span class="n">calculate_storage_selection</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">after_timestep</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="c1"># NOTE: benchmarks parse this, do not change / remove</span>
        <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">profile_mode</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Time step took </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">last_time</span><span class="p">)</span>

<div class="viewcode-block" id="RogerSetup.warmup"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.warmup">[docs]</a>    <span class="k">def</span> <span class="nf">warmup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Warmup routine of the simulation.</span>

<span class="sd">        Args</span>
<span class="sd">        -------</span>
<span class="sd">        repeat : int, optional</span>
<span class="sd">            Number of warmup runs. Default is 1.</span>

<span class="sd">        Note</span>
<span class="sd">        -------</span>
<span class="sd">        Make sure to call :meth:`setup` prior to this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">roger</span> <span class="kn">import</span> <span class="n">diagnostics</span>
        <span class="kn">from</span> <span class="nn">roger.core</span> <span class="kn">import</span> <span class="n">soil</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">enable_offline_transport</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;warmup&quot;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting warmup&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repeat</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                    <span class="n">soil</span><span class="o">.</span><span class="n">rescale_SA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">unlock</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">itt</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">unlock</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">warmup_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">warmup_done</span><span class="p">:</span>
            <span class="c1"># write initial values to output after warmup</span>
            <span class="n">diagnostics</span><span class="o">.</span><span class="n">diagnose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">diagnostics</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span></div>

<div class="viewcode-block" id="RogerSetup.run"><a class="viewcode-back" href="../../reference/api/roger-setup.html#roger.RogerSetup.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Main routine of the simulation.</span>

<span class="sd">        Args</span>
<span class="sd">        -------</span>
<span class="sd">        show_progress_bar (:obj:`bool`, optional): Whether to show fancy progress bar via tqdm.</span>
<span class="sd">            By default, only show if stdout is a terminal and roger is running on a single process.</span>

<span class="sd">        Note</span>
<span class="sd">        -------</span>
<span class="sd">        Make sure to call :meth:`setup` (and :meth:`warmup` if offline transport)</span>
<span class="sd">        prior to this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">roger</span> <span class="kn">import</span> <span class="n">restart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_setup_done</span><span class="p">()</span>

        <span class="n">vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">variables</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">settings</span>

        <span class="n">time_length</span><span class="p">,</span> <span class="n">time_unit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">format_time</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">runlen</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting calculation for </span><span class="si">{</span><span class="n">time_length</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">time_unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">time</span>

        <span class="c1"># disable timers for first iteration</span>
        <span class="n">timer_context</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">get_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">use_tqdm</span><span class="o">=</span><span class="n">show_progress_bar</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">signals</span><span class="o">.</span><span class="n">signals_to_exception</span><span class="p">(),</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">vs</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">runlen</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">timer_context</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                        <span class="n">timer_context</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">pbar</span><span class="o">.</span><span class="n">advance_time</span><span class="p">(</span><span class="n">vs</span><span class="o">.</span><span class="n">dt_secs</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stopping calculation at iteration </span><span class="si">{</span><span class="n">vs</span><span class="o">.</span><span class="n">itt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">warmup_done</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Warmup done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Calculation done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">write_restart</span><span class="p">:</span>
                <span class="n">restart</span><span class="o">.</span><span class="n">write_restart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timing_summary</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_timing_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">timing_summary</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">timing_summary</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Timing summary:&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;(excluding first iteration)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;---&quot;</span><span class="p">,</span>
                    <span class="s2">&quot; setup time                 = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;setup&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot; main loop time             = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   boundary conditions      = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;boundary conditions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   forcing                  = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   time-variant parameters  = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;time-variant parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   interception             = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;interception&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   evapotranspiration       = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;evapotranspiration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   snow                     = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;snow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   infiltration             = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;infiltration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   capillary rise           = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;capillary rise&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   subsurface flow          = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;subsurface runoff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   groundwater flow         = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;groundwater flow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   crops                    = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;crops&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   storage                  = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   routing                  = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;routing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;main transport&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">timing_summary</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Timing summary:&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;(excluding first iteration)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;---&quot;</span><span class="p">,</span>
                    <span class="s2">&quot; setup time                                      = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;setup&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot; warmup time                                     = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;warmup&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot; main loop time                                  = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;main transport&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   boundary conditions                           = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;boundary conditions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   forcing                                       = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   redistribution after root growth/harvesting   = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;redistribution after root growth/harvesting&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   infiltration into root zone                   = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;infiltration into root zone&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   evapotranspiration                            = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;evapotranspiration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   infiltration into subsoil                     = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;infiltration into subsoil&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   subsurface runoff of root zone                = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;subsurface runoff of root zone&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   subsurface runoff of subsoil                  = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;subsurface runoff of subsoil&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   capillary rise into root zone                 = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;capillary rise into root zone&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   capillary rise into subsoil                   = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;capillary rise into subsoil&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   ageing                                        = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;ageing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   storage                                       = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   nitrogen cycle                                = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;nitrogen cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                    <span class="s2">&quot;   routing                                       = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;routing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">profile_mode</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">timing_summary</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot; diagnostics and I/O      = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">timing_summary</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;   </span><span class="si">{:&lt;22}</span><span class="s2"> = </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plugin</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">plugin</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_plugin_interfaces</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timing_summary</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">profile_mode</span><span class="p">:</span>
            <span class="n">print_profile_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">profile_timers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_time</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">print_profile_summary</span><span class="p">(</span><span class="n">profile_timers</span><span class="p">,</span> <span class="n">main_loop_time</span><span class="p">):</span>
    <span class="n">profile_timings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Profile timings:&quot;</span><span class="p">,</span> <span class="s2">&quot;[total time spent (</span><span class="si">% o</span><span class="s2">f main loop)]&quot;</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span><span class="p">]</span>
    <span class="n">maxwidth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">profile_timers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">profile_format_string</span> <span class="o">=</span> <span class="s2">&quot;{{:&lt;</span><span class="si">{}</span><span class="s2">}} = {{:.2f}}s ({{:.2f}}%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxwidth</span><span class="p">)</span>
    <span class="n">main_loop_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">main_loop_time</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>  <span class="c1"># prevent division by 0</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">timer</span> <span class="ow">in</span> <span class="n">profile_timers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">this_time</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">total_time</span>
        <span class="k">if</span> <span class="n">this_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">profile_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profile_format_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">this_time</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">this_time</span> <span class="o">/</span> <span class="n">main_loop_time</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">diagnostic</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profile_timings</span><span class="p">))</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2022, The RoGeR Team, University of Freiburg.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>